from keyboards import get_main_kb, peek_kb, cat_kb, next_kb

def handle_story(data, game, uid):
    text = None
    kb = None
    if data == "wolf_flee":
        game.add_log(
            "Ты медленно пятишься назад, стараясь не хрустнуть ни одной веткой.\n"
            "Через несколько шагов рычание стихает за деревьями.\n"
            "Что бы там ни было под пнём — оно теперь не твоё дело.\n"
            "Сердце всё ещё колотится."
        )
        game.story_state = None
        game.reset_nav()
        text = game.get_ui()
        kb = get_main_kb(game)
    elif data == "wolf_fight":
        fight_text = (
            "Ты поднимаешь факел повыше. Пламя трещит громче.\n"
            "Волк резко оборачивается, глаза вспыхивают жёлтым в свете огня.\n"
            "Секунду он смотрит на тебя — не нападает, но и не отступает.\n"
            "Тогда ты делаешь шаг вперёд и рычишь сам — низко, зло, по-человечески неумело.\n"
            "Факел вспыхивает ярче от рывка воздуха.\n"
            "Зверь подается назад и ты замахиваешься факелом.\n"
            "Ещё мгновение — и ты видишь как подпалённый волк убегает в темноту между деревьями, бросив свою яму.\n"
            "Остатки факела медленно догорают на земле возле тебя.\n\n"
            "Теперь перед тобой открытая яма под пнём."
        )
        game.equipment["hand"] = None
        game.inventory["Факел"] = max(0, game.inventory.get("Факел", 0) - 1)
        game.story_state = "after_fight"
        text = fight_text
        kb = peek_kb
    elif data == "peek_den":
        text = (
            "Ты опускаешься на колени, наклоняешься ближе.\n"
            "В слабом отсвете угасающих угольков факела, почти на самом дне ямы, блестят два огромных влажных глаза.\n"
            "Они смотрят на тебя с ужасом и надеждой одновременно.\n"
            "Маленький, грязный, дрожащий котёнок.\n"
            "Шерсть слиплась от сырости, одно ухо надорвано.\n"
            "Ты тихо протягиваешь руку.\n"
            "Он долго не решается. Потом осторожно, очень медленно обнюхивает твои пальцы.\n"
            "Ты чувствуешь холодный нос и слабое, прерывистое дыхание.\n\n"
            "Твои действия:"
        )
        kb = cat_kb
        game.story_state = "cat_choice"
    elif data == "cat_leave":
        game.add_log(
            "Ты медленно убираешь руку.\n"
            "Котёнок смотрит тебе вслед, но не мяукает.\n"
            "Ты встаёшь, разворачиваешься и уходишь.\n"
            "За спиной остаётся только тишина леса и ощущение, что ты только что прошёл мимо чего-то важного."
        )
        game.karma -= 50
        game.story_state = None
        game.reset_nav()
        text = game.get_ui()
        kb = get_main_kb(game)
    elif data == "cat_take":
        game.story_state = "cat_name_wait"
        text = (
            "Ты осторожно опускаешь обе ладони в яму.\n"
            "Котёнок сначала отшатывается, потом сам делает маленький шаг навстречу.\n"
            "Через секунду он уже у тебя на руках — лёгкий, холодный, дрожащий всем телом.\n"
            "Ты прижимаешь его к груди, прикрывая полой куртки.\n\n"
            "Как ты его назовёшь?"
        )
        kb = None
    elif data == "story_next":
        game.story_state = None
        game.reset_nav()
        text = game.get_ui()
        kb = get_main_kb(game)
    return text, kb
